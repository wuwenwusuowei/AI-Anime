<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¨ EduMatch æ¼«æ”¹è§†é¢‘ç”Ÿæˆå™¨</title>
    <meta http-equiv="Content-Security-Policy" content="
        script-src 'self' 'unsafe-inline' https://unpkg.com; 
        style-src 'self' 'unsafe-inline'; 
        img-src 'self' data: blob:; 
        media-src 'self' blob:; 
        connect-src 'self' http://localhost:3000 ws://localhost:3000 ws: wss:; 
        font-src 'self';
        object-src 'none';
        base-uri 'self';
        form-action 'self';
        frame-ancestors 'self';
    ">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* éšè—å¼€å‘å·¥å…·è­¦å‘Š */
        .chrome-devtools-warning {
            display: none !important;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .initial-loading {
            text-align: center;
            color: white;
            padding: 40px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .pulse {
            display: inline-block;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .debug-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            max-width: 300px;
            z-index: 1000;
        }
        
        .debug-info pre {
            margin: 5px 0 0 0;
            white-space: pre-wrap;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div v-if="loading && !taskId" class="initial-loading">
            <div class="loading-spinner"></div>
            <p>æ­£åœ¨åŠ è½½åº”ç”¨...</p>
        </div>
    </div>
    
    <script>
        // ç­‰å¾… Vue åŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            try {
                const { createApp, ref, computed } = Vue;
                
                const App = {
                    template: `
                        <div class="container">
                            <h1>ğŸ¨ EduMatch æ¼«æ”¹è§†é¢‘ç”Ÿæˆå™¨</h1>
                            
                            <div class="input-section">
                                <!-- 1. å›¾ç‰‡ä¸Šä¼ åŒº -->
                                <div class="upload-box" @click="triggerUpload" :class="{ 'has-image': previewUrl }">
                                    <input 
                                        type="file" 
                                        ref="fileInput" 
                                        @change="handleFileChange" 
                                        accept="image/*" 
                                        style="display: none"
                                    >
                                    <div v-if="!previewUrl" class="placeholder">
                                        <span class="icon">ğŸ–¼ï¸</span>
                                        <p>ç‚¹å‡»ä¸Šä¼ ä¸€å¼ å½©è‰²æ¼«ç”»/äºŒæ¬¡å…ƒå›¾ç‰‡</p>
                                    </div>
                                    <img v-else :src="previewUrl" class="preview-img" @error="handleImageError" />
                                </div>
                                
                                <!-- 2. åŠ¨ä½œæè¿° -->
                                <textarea 
                                    v-model="prompt" 
                                    placeholder="æƒ³è®©å®ƒæ€ä¹ˆåŠ¨ï¼Ÿï¼ˆä¾‹å¦‚ï¼šå¾®é£å¹æ‹‚ï¼Œå¤´å‘é£˜åŠ¨ï¼Œå¾®ç¬‘ï¼Œçœ¨çœ¼ï¼‰"
                                    rows="3"
                                ></textarea>
                                
                                <div class="controls">
                                    <select v-model="style">
                                        <option value="anime">æ—¥å¼åŠ¨æ¼«</option>
                                        <option value="cyberpunk">èµ›åšæœ‹å…‹</option>
                                        <option value="ink">æ°´å¢¨å›½é£</option>
                                    </select>
                                    
                                    <button @click="handleGenerate" :disabled="loading || !selectedFile">
                                        {{ loading ? 'æ­£åœ¨æ–½æ³•ä¸­...' : 'è®©å›¾åŠ¨èµ·æ¥ âœ¨' }}
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 3. çŠ¶æ€ä¸ç»“æœ -->
                            <div v-if="taskId" class="status-box">
                                <p>ä»»åŠ¡ ID: {{ taskId }}</p>
                                <p>çŠ¶æ€: <span :class="status">{{ statusText }}</span></p>
                                <p v-if="status === 'PROCESSING'" class="loading-text">
                                    <span class="pulse">â³</span> AI æ­£åœ¨ç–¯ç‹‚ç»˜åˆ¶ä¸­ (çº¦éœ€2-3åˆ†é’Ÿ)...
                                </p>
                            </div>
                            
                            <div v-if="videoUrl" class="result-section">
                                <h3>ğŸ‰ ç”ŸæˆæˆåŠŸï¼</h3>
                                <div class="video-container">
                                    <video 
                                        controls 
                                        :src="videoUrl" 
                                        autoplay 
                                        loop
                                        @error="handleVideoError"
                                        @loadeddata="handleVideoLoaded"
                                    ></video>
                                </div>
                                <div style="margin-top: 10px;">
                                    <a :href="videoUrl" target="_blank" download>
                                        <button class="download-btn">ğŸ“¥ ä¸‹è½½è§†é¢‘</button>
                                    </a>
                                </div>
                            </div>
                            
                            <div v-if="error" class="error-msg" @click="clearError">
                                <strong>âš ï¸ é”™è¯¯:</strong> {{ error }}
                                <small style="display: block; margin-top: 5px; opacity: 0.7;">ç‚¹å‡»æ­¤æ¶ˆæ¯å¯æ¸…é™¤</small>
                            </div>
                            
                            <!-- å¼€å‘ç¯å¢ƒè°ƒè¯•ä¿¡æ¯ -->
                            <div v-if="debugMode" class="debug-info">
                                <h4>ğŸ› è°ƒè¯•ä¿¡æ¯</h4>
                                <pre>{{ debugInfo }}</pre>
                            </div>
                        </div>
                    `,
                    setup() {
                        const prompt = ref('')
                        const style = ref('anime')
                        const loading = ref(false)
                        const taskId = ref(null)
                        const status = ref('')
                        const videoUrl = ref('')
                        const error = ref('')
                        const selectedFile = ref(null)
                        const previewUrl = ref('')
                        const fileInput = ref(null)
                        const debugMode = ref(window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
                        const debugInfo = ref({})
                        
                        // è®¡ç®—çŠ¶æ€æ–‡æœ¬
                        const statusText = computed(() => {
                            const statusMap = {
                                'PENDING': 'ğŸ“ ä»»åŠ¡å·²æäº¤',
                                'PROCESSING': 'ğŸ¨ æ­£åœ¨ç”Ÿæˆ',
                                'COMPLETED': 'âœ… ç”Ÿæˆå®Œæˆ',
                                'FAILED': 'âŒ ç”Ÿæˆå¤±è´¥'
                            }
                            return statusMap[status.value] || status.value
                        })
                        
                        // æ›´æ–°è°ƒè¯•ä¿¡æ¯
                        const updateDebugInfo = () => {
                            debugInfo.value = {
                                taskId: taskId.value,
                                status: status.value,
                                videoUrl: videoUrl.value ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®',
                                error: error.value || 'æ— é”™è¯¯',
                                loading: loading.value,
                                selectedFile: selectedFile.value ? selectedFile.value.name : 'æœªé€‰æ‹©',
                                timestamp: new Date().toLocaleString()
                            }
                        }
                        
                        // è§¦å‘æ–‡ä»¶é€‰æ‹©
                        const triggerUpload = () => {
                            try {
                                fileInput.value.click()
                            } catch (err) {
                                console.error('æ–‡ä»¶é€‰æ‹©å¤±è´¥:', err)
                                error.value = 'æ–‡ä»¶é€‰æ‹©åŠŸèƒ½ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®'
                            }
                        }
                        
                        // å¤„ç†æ–‡ä»¶é€‰æ‹©
                        const handleFileChange = (event) => {
                            try {
                                const file = event.target.files[0]
                                if (file) {
                                    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                                    if (!file.type.startsWith('image/')) {
                                        error.value = 'è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼'
                                        return
                                    }
                                    
                                    // æ£€æŸ¥æ–‡ä»¶å¤§å° (é™åˆ¶10MB)
                                    if (file.size > 10 * 1024 * 1024) {
                                        error.value = 'å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡ 10MBï¼'
                                        return
                                    }
                                    
                                    selectedFile.value = file
                                    previewUrl.value = URL.createObjectURL(file)
                                    error.value = '' // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯
                                    updateDebugInfo()
                                }
                            } catch (err) {
                                console.error('æ–‡ä»¶å¤„ç†å¤±è´¥:', err)
                                error.value = 'æ–‡ä»¶å¤„ç†å¤±è´¥: ' + err.message
                            }
                        }
                        
                        // å¤„ç†å›¾ç‰‡åŠ è½½é”™è¯¯
                        const handleImageError = (event) => {
                            console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', event)
                            error.value = 'å›¾ç‰‡é¢„è§ˆå¤±è´¥ï¼Œè¯·é‡è¯•ä¸Šä¼ '
                        }
                        
                        // å¤„ç†è§†é¢‘åŠ è½½é”™è¯¯
                        const handleVideoError = (event) => {
                            console.error('è§†é¢‘åŠ è½½å¤±è´¥:', event)
                            error.value = 'è§†é¢‘åŠ è½½å¤±è´¥ï¼Œå¯èƒ½è¿˜æœªå®Œå…¨ç”Ÿæˆï¼Œè¯·ç¨åé‡è¯•'
                        }
                        
                        // å¤„ç†è§†é¢‘åŠ è½½æˆåŠŸ
                        const handleVideoLoaded = () => {
                            console.log('è§†é¢‘åŠ è½½æˆåŠŸ')
                            updateDebugInfo()
                        }
                        
                        // æ¸…é™¤é”™è¯¯
                        const clearError = () => {
                            error.value = ''
                            updateDebugInfo()
                        }
                        
                        // ç‚¹å‡»ç”Ÿæˆ
                        const handleGenerate = async () => {
                            if (!selectedFile.value) {
                                error.value = 'è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼'
                                return
                            }
                            
                            loading.value = true
                            error.value = ''
                            videoUrl.value = ''
                            status.value = 'æäº¤ä¸­...'
                            updateDebugInfo()
                            
                            try {
                                const formData = new FormData()
                                formData.append('image', selectedFile.value)
                                formData.append('prompt', prompt.value || 'è‡ªåŠ¨ç”ŸæˆåŠ¨ç”»æ•ˆæœ')
                                formData.append('style', style.value)
                                
                                // æ·»åŠ è¶…æ—¶æ§åˆ¶
                                const controller = new AbortController()
                                const timeoutId = setTimeout(() => controller.abort(), 30000) // 30ç§’è¶…æ—¶
                                
                                const res = await fetch('http://localhost:3000/api/generate', {
                                    method: 'POST',
                                    body: formData,
                                    signal: controller.signal
                                })
                                
                                clearTimeout(timeoutId)
                                
                                if (!res.ok) {
                                    throw new Error(\`HTTP \${res.status}: \${res.statusText}\`)
                                }
                                
                                const data = await res.json()
                                
                                if (data.success) {
                                    taskId.value = data.taskId
                                    status.value = 'PENDING'
                                    pollStatus(data.taskId)
                                    updateDebugInfo()
                                } else {
                                    error.value = 'æäº¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯')
                                    loading.value = false
                                    updateDebugInfo()
                                }
                            } catch (err) {
                                if (err.name === 'AbortError') {
                                    error.value = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'
                                } else {
                                    error.value = 'ç½‘ç»œé”™è¯¯: ' + err.message
                                }
                                loading.value = false
                                updateDebugInfo()
                            }
                        }
                        
                        // è½®è¯¢çŠ¶æ€
                        const pollStatus = async (id) => {
                            let retryCount = 0
                            const maxRetries = 200 // æœ€å¤šè½®è¯¢200æ¬¡ (10åˆ†é’Ÿ)
                            
                            const interval = setInterval(async () => {
                                try {
                                    retryCount++
                                    if (retryCount > maxRetries) {
                                        error.value = 'æŸ¥è¯¢è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•'
                                        loading.value = false
                                        clearInterval(interval)
                                        return
                                    }
                                    
                                    const res = await fetch(\`http://localhost:3000/api/status/\${id}\`, {
                                        method: 'GET',
                                        headers: {
                                            'Cache-Control': 'no-cache'
                                        }
                                    })
                                    
                                    if (!res.ok) {
                                        throw new Error(\`HTTP \${res.status}: \${res.statusText}\`)
                                    }
                                    
                                    const data = await res.json()
                                    status.value = data.status
                                    updateDebugInfo()
                                    
                                    if (data.status === 'COMPLETED') {
                                        videoUrl.value = data.videoUrl
                                        loading.value = false
                                        clearInterval(interval)
                                        updateDebugInfo()
                                    }
                                    
                                    if (data.status === 'FAILED') {
                                        error.value = 'ç”Ÿæˆå¤±è´¥: ' + (data.error || 'è¯·æ£€æŸ¥åç«¯æ—¥å¿—')
                                        loading.value = false
                                        clearInterval(interval)
                                        updateDebugInfo()
                                    }
                                    
                                } catch (err) {
                                    console.error('è½®è¯¢å‡ºé”™:', err)
                                    if (retryCount % 10 === 0) { // æ¯30ç§’è®°å½•ä¸€æ¬¡é”™è¯¯
                                        error.value = 'çŠ¶æ€æŸ¥è¯¢å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•...'
                                    }
                                }
                            }, 3000)
                        }
                        
                        // åˆå§‹åŒ–
                        updateDebugInfo()
                        
                        return {
                            prompt,
                            style,
                            loading,
                            taskId,
                            status,
                            videoUrl,
                            error,
                            selectedFile,
                            previewUrl,
                            fileInput,
                            debugMode,
                            debugInfo,
                            statusText,
                            triggerUpload,
                            handleFileChange,
                            handleImageError,
                            handleVideoError,
                            handleVideoLoaded,
                            clearError,
                            handleGenerate,
                            pollStatus
                        }
                    }
                }
                
        // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(event) {
            console.error('å…¨å±€é”™è¯¯:', event.error)
            // å¿½ç•¥ Chrome DevTools ç›¸å…³é”™è¯¯
            if (event.filename && event.filename.includes('chrome-extension://')) {
                return
            }
        })
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason)
        })
        
        // æ‹¦æˆªå¹¶å¿½ç•¥ Chrome DevTools çš„è¿æ¥è¯·æ±‚
        const originalFetch = window.fetch
        window.fetch = function(...args) {
            const url = args[0]
            // å¿½ç•¥ Chrome DevTools çš„è¿æ¥è¯·æ±‚
            if (typeof url === 'string' && url.includes('chrome.devtools')) {
                return Promise.reject(new Error('Chrome DevTools request blocked'))
            }
            return originalFetch.apply(this, args)
        }
                
                createApp(App).mount('#app')
                
            } catch (err) {
                console.error('åº”ç”¨å¯åŠ¨å¤±è´¥:', err)
                document.getElementById('app').innerHTML = \`
                    <div style="
                        background: #fee; 
                        padding: 20px; 
                        border-radius: 8px; 
                        margin: 20px; 
                        text-align: center;
                        color: #c00;
                    ">
                        <h2>âŒ åº”ç”¨å¯åŠ¨å¤±è´¥</h2>
                        <p>é”™è¯¯ä¿¡æ¯: \${err.message}</p>
                        <p>è¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼Œæˆ–æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°</p>
                        <button onclick="location.reload()" style="
                            background: #007bff; 
                            color: white; 
                            border: none; 
                            padding: 10px 20px; 
                            border-radius: 4px; 
                            cursor: pointer;
                        ">åˆ·æ–°é¡µé¢</button>
                    </div>
                \`
            }
        })
    </script>
    
    <style>
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
            font-family: sans-serif; 
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .upload-box { 
            border: 3px dashed #ccc; 
            border-radius: 12px; 
            height: 250px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            margin-bottom: 20px; 
            overflow: hidden; 
            position: relative;
            transition: all 0.3s ease;
            background: #fafafa;
        }
        
        .upload-box:hover { 
            border-color: #646cff; 
            background: #f0f4ff; 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(100, 108, 255, 0.15);
        }
        
        .upload-box.has-image { 
            border-style: solid; 
            border-color: #646cff; 
            background: #fff;
        }
        
        .preview-img { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            background: #000; 
        }
        
        .placeholder { 
            text-align: center; 
            color: #666; 
        }
        
        .icon { 
            font-size: 50px; 
            display: block; 
            margin-bottom: 15px; 
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        textarea { 
            width: 100%; 
            padding: 15px; 
            border-radius: 12px; 
            border: 2px solid #e0e0e0; 
            margin-bottom: 20px; 
            box-sizing: border-box; 
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s ease;
            resize: vertical;
        }
        
        textarea:focus {
            outline: none;
            border-color: #646cff;
            box-shadow: 0 0 0 3px rgba(100, 108, 255, 0.1);
        }
        
        .controls { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 20px;
        }
        
        button { 
            flex: 1; 
            background: linear-gradient(135deg, #646cff 0%, #7b8bff 100%); 
            color: white; 
            border: none; 
            padding: 15px 20px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(100, 108, 255, 0.3);
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(100, 108, 255, 0.4);
        }
        
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        
        select { 
            padding: 15px; 
            border-radius: 12px; 
            border: 2px solid #e0e0e0; 
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        
        select:focus {
            outline: none;
            border-color: #646cff;
        }
        
        .result-section video { 
            width: 100%; 
            border-radius: 16px; 
            margin-top: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
        }
        
        .status-box { 
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
            padding: 20px; 
            margin-top: 20px; 
            border-radius: 16px; 
            text-align: center; 
            border: 1px solid #dee2e6;
        }
        
        .COMPLETED { 
            color: #28a745; 
            font-weight: bold; 
            font-size: 1.1em;
        }
        
        .PROCESSING { 
            color: #fd7e14; 
            font-weight: bold; 
            font-size: 1.1em;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .error-msg { 
            color: #dc3545; 
            margin-top: 20px; 
            text-align: center; 
            padding: 15px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 12px;
        }
        
        .loading-text {
            color: #6c757d;
            font-style: italic;
            margin-top: 10px;
        }
        
        .download-btn { 
            background: linear-gradient(135deg, #28a745 0%, #34ce57 100%); 
            width: auto; 
            padding: 12px 30px; 
            margin-top: 15px;
            text-decoration: none;
            display: inline-block;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }
    </style>
</body>
</html>