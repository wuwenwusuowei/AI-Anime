<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS éŸ³è‰²æµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .voice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .voice-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            background: #fafafa;
            transition: all 0.3s ease;
        }
        
        .voice-card:hover {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .voice-card.verified {
            border-left: 4px solid #67c23a;
        }
        
        .voice-card.unverified {
            border-left: 4px solid #e6a23c;
        }
        
        .voice-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .voice-gender {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 8px;
        }
        
        .voice-gender.female {
            background: #ffe6e6;
            color: #d63384;
        }
        
        .voice-gender.male {
            background: #e6f3ff;
            color: #0066cc;
        }
        
        .voice-status {
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .test-btn {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }
        
        .test-btn:hover {
            background: #337ecc;
        }
        
        .test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .audio-player {
            margin-top: 15px;
            width: 100%;
            border-radius: 4px;
        }
        
        .loading {
            color: #409eff;
            font-size: 12px;
        }
        
        .error {
            color: #f56c6c;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .success {
            color: #67c23a;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .recommendations {
            background: #f0f9ff;
            border: 1px solid #b3d8ff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .recommendations h3 {
            color: #409eff;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ TTS éŸ³è‰²æµ‹è¯•å·¥å…·</h1>
        
        <div class="recommendations">
            <h3>ğŸ”¥ æ¨èéŸ³è‰²ï¼ˆå·²éªŒè¯å¯ç”¨ï¼‰</h3>
            <ul>
                <li><strong>æŠ’æƒ…å¥³å£°</strong> - æ ‡å‡†ä¸­æ–‡å¥³å£°ï¼ŒéŸ³è‰²æ¸…æ™°è‡ªç„¶</li>
                <li><strong>ä¼˜é›…å¥³å£«</strong> - æˆç†Ÿå¥³å£°ï¼Œé€‚åˆæ­£å¼åœºåˆ</li>
                <li><strong>æ¸¯å¼ç©ºå°‘éŸ³</strong> - æ ‡å‡†ç”·å£°ï¼Œå‘éŸ³æ¸…æ™°</li>
            </ul>
        </div>
        
        <div id="voiceGrid" class="voice-grid">
            <!-- éŸ³è‰²å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        let currentAudios = {}; // å­˜å‚¨å½“å‰æ’­æ”¾çš„éŸ³é¢‘

        // åŠ è½½éŸ³è‰²åˆ—è¡¨
        async function loadVoices() {
            try {
                const response = await fetch(`${API_BASE}/api/tts/voices`);
                const result = await response.json();
                
                if (result.success) {
                    displayVoices(result.voices);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('åŠ è½½éŸ³è‰²å¤±è´¥:', error);
                document.getElementById('voiceGrid').innerHTML = 
                    `<div class="error">åŠ è½½éŸ³è‰²å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ˜¾ç¤ºéŸ³è‰²åˆ—è¡¨
        function displayVoices(voices) {
            const voiceGrid = document.getElementById('voiceGrid');
            let html = '';
            
            // åˆå¹¶æ‰€æœ‰è¯­è¨€çš„éŸ³è‰²
            const allVoices = [];
            Object.values(voices).forEach(languageVoices => {
                if (Array.isArray(languageVoices)) {
                    allVoices.push(...languageVoices);
                }
            });
            
            allVoices.forEach(voice => {
                const isVerified = voice.verified !== false;
                const statusClass = isVerified ? 'verified' : 'unverified';
                const statusIcon = isVerified ? 'âœ…' : 'âš ï¸';
                
                html += `
                    <div class="voice-card ${statusClass}">
                        <div class="voice-name">${voice.name}</div>
                        <span class="voice-gender ${voice.gender === 'å¥³' ? 'female' : 'male'}">
                            ${voice.gender}
                        </span>
                        <div class="voice-status">
                            ${statusIcon} ${isVerified ? 'å·²éªŒè¯' : 'éœ€è¦éªŒè¯'}
                        </div>
                        <button class="test-btn" onclick="testVoice('${voice.id}', '${voice.name}')">
                            ğŸµ æµ‹è¯•éŸ³è‰²
                        </button>
                        <div id="status-${voice.id.replace(/[^a-zA-Z0-9]/g, '')}"></div>
                        <div id="audio-${voice.id.replace(/[^a-zA-Z0-9]/g, '')}"></div>
                    </div>
                `;
            });
            
            voiceGrid.innerHTML = html;
        }

        // æµ‹è¯•éŸ³è‰²
        async function testVoice(voiceId, voiceName) {
            const statusId = `status-${voiceId.replace(/[^a-zA-Z0-9]/g, '')}`;
            const audioId = `audio-${voiceId.replace(/[^a-zA-Z0-9]/g, '')}`;
            const statusDiv = document.getElementById(statusId);
            const audioDiv = document.getElementById(audioId);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            statusDiv.innerHTML = '<span class="loading">ğŸ”„ æ­£åœ¨ç”Ÿæˆè¯­éŸ³...</span>';
            audioDiv.innerHTML = '';
            
            try {
                const response = await fetch(`${API_BASE}/api/tts/test-voice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        voiceId: voiceId,
                        text: `ä½ å¥½ï¼Œæˆ‘æ˜¯${voiceName}ï¼Œè¿™æ˜¯ä¸€æ®µè¯­éŸ³æµ‹è¯•ï¼Œè¯·å¬å¬æˆ‘çš„å£°éŸ³æ•ˆæœå¦‚ä½•ã€‚`
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.testResult && result.testResult.hasAudio) {
                    // ç”Ÿæˆå®Œæ•´çš„TTSæ¥è·å–éŸ³é¢‘URL
                    await generateFullTTS(voiceId, voiceName, statusId, audioId);
                } else {
                    throw new Error(result.error || 'éŸ³è‰²æµ‹è¯•å¤±è´¥');
                }
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</span>`;
            }
        }

        // ç”Ÿæˆå®Œæ•´çš„TTSéŸ³é¢‘
        async function generateFullTTS(voiceId, voiceName, statusId, audioId) {
            try {
                const response = await fetch(`${API_BASE}/api/tts/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: `ä½ å¥½ï¼Œæˆ‘æ˜¯${voiceName}ï¼Œè¿™æ˜¯ä¸€æ®µè¯­éŸ³æµ‹è¯•ï¼Œè¯·å¬å¬æˆ‘çš„å£°éŸ³æ•ˆæœå¦‚ä½•ã€‚`,
                        voiceType: voiceId,
                        language: 'zh-CN',
                        speed: 1.0,
                        volume: 80,
                        outputFormat: 'mp3'
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.audioUrl) {
                    // åœæ­¢ä¹‹å‰çš„éŸ³é¢‘
                    if (currentAudios[voiceId]) {
                        currentAudios[voiceId].pause();
                    }
                    
                    document.getElementById(statusId).innerHTML = 
                        `<span class="success">âœ… æµ‹è¯•æˆåŠŸï¼</span>`;
                    
                    document.getElementById(audioId).innerHTML = `
                        <audio controls class="audio-player" id="audio-element-${voiceId}">
                            <source src="${result.audioUrl}" type="audio/mpeg">
                            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                        </audio>
                    `;
                    
                    // ä¿å­˜éŸ³é¢‘å…ƒç´ å¼•ç”¨
                    const audioElement = document.getElementById(`audio-element-${voiceId}`);
                    currentAudios[voiceId] = audioElement;
                    
                    // è‡ªåŠ¨æ’­æ”¾
                    audioElement.play().catch(e => {
                        console.log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', e);
                        document.getElementById(statusId).innerHTML += 
                            `<br><small>è¯·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾</small>`;
                    });
                } else {
                    throw new Error(result.error || 'è¯­éŸ³ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                document.getElementById(statusId).innerHTML = 
                    `<span class="error">âŒ ç”Ÿæˆå¤±è´¥: ${error.message}</span>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', loadVoices);
    </script>
</body>
</html>