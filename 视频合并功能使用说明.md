# 视频拼接功能使用说明

## 📋 功能概述

视频拼接功能（Merge.vue）允许你将多个生成的视频片段无缝拼接成一个完整的视频作品。这个功能在**漫改视频工作室**中实现，特别适合制作连续的动漫视频。

## 🎯 使用步骤

### 1. 准备视频素材

在开始拼接之前，你需要先生成多个视频片段：

1. 进入**漫改视频工作室**页面
2. 上传多张原始图片（建议 3-10 张）
3. 为每张图片编写导演指令（描述每个镜头的内容）
4. 逐个生成视频片段

### 2. 生成视频片段

对于每个图片，你需要完成两个阶段：

#### 阶段一：漫改图片（图生图）
- 选择模型：ComfyUI 或 豆包（即梦）
- 选择目标画幅：9:16、1:1、16:9、3:4
- 点击"漫改图片"按钮
- 等待图片生成完成

#### 阶段二：生成视频（图生视频）

**标准视频模式（1-5秒）：**
- 选择时长：使用滑块选择 1-5 秒
- 选择模式：
  - 单图模式：AI 根据一张图自由生成动作
  - 首尾帧模式：上传结束帧，控制视频的起始和结束状态

**长片段视频模式（12秒或20秒）：**
- 点击"长片段视频"切换模式
- 选择时长：~12秒 或 20秒

- 点击"生成视频"按钮
- 等待视频生成完成

### 3. 导出完整视频

所有视频片段生成完成后：

1. 查看右下角的"作品合成"区域
2. 确认"已完成 X/5 个视频"（X 应该等于总片段数）
3. 点击"导出完整视频"按钮
4. 等待合并完成
5. 自动下载合并后的完整视频

## 🔧 技术实现

### 后端实现

使用 `fluent-ffmpeg` 和 `@ffmpeg-installer/ffmpeg` npm 包：

```javascript
import ffmpeg from 'fluent-ffmpeg';
import ffmpegPath from '@ffmpeg-installer/ffmpeg';

// 设置 FFmpeg 路径
ffmpeg.setFfmpegPath(ffmpegPath.path);
```

**合并流程：**
1. 接收前端发送的视频 URL 列表
2. 下载所有视频到本地临时目录
3. 创建 FFmpeg 文件列表（list.txt）
4. 使用 concat 协议合并视频
5. 返回合并后的视频 URL

**FFmpeg 命令：**
```bash
ffmpeg -f concat -safe 0 -i list.txt -c copy -y output.mp4
```

### 前端实现

**状态管理：**
- `mergeItems`: 存储所有视频片段的详细信息
- `generating`: 生成中的状态标识
- `mergeProcessing`: 合并中的状态标识

**关键函数：**
- `handleGenerateVideo()`: 生成单个视频片段
- `handleMergeVideos()`: 合并所有完成的视频
- `pollI2VResult()`: 轮询查询视频生成状态

## 💡 使用技巧

### 1. 批量生成视频

- 一次性上传多张图片
- 按顺序填写导演指令
- 逐个生成所有视频片段
- 最后一次性合并

### 2. 保持一致性

- 使用相同的画幅比例（建议统一为 16:9 或 9:16）
- 使用相同的时长模式（建议都用标准模式）
- 导演指令要连贯，讲述一个完整的故事

### 3. 首尾帧模式

如果你想精确控制每个视频片段的起始和结束状态：
- 启用"首尾帧模式"
- 上传下一张图片作为当前视频的结束帧
- 这样可以确保视频之间的连贯性

## ⚠️ 注意事项

### 1. FFmpeg 依赖

本项目使用 npm 包方式安装 FFmpeg，无需手动配置系统环境变量：

```bash
npm install @ffmpeg-installer/ffmpeg fluent-ffmpeg
```

### 2. 视频格式要求

- 所有视频必须是 MP4 格式
- 建议使用相同的编码格式（H.264）
- 画幅比例应该一致

### 3. 网络要求

- 视频下载需要稳定的网络连接
- 合并时间取决于视频总时长和文件大小
- 建议视频总时长不超过 5 分钟

### 4. 存储空间

- 临时文件会保存在 `uploads/merged` 目录
- 合并完成后会自动清理临时文件
- 确保有足够的磁盘空间

## 🐛 常见问题

### Q1: 点击"导出完整视频"没有反应

**A:** 检查以下几点：
- 确认所有视频片段都已生成完成（状态为"已就绪"）
- 查看浏览器控制台是否有错误信息
- 检查网络连接是否正常

### Q2: 合并后的视频无法播放

**A:** 可能的原因：
- 视频格式不一致（都是 MP4 但编码不同）
- 尝试重新生成视频片段，使用相同的画幅和时长
- 查看 Node.js 控制台的错误信息

### Q3: 下载速度很慢

**A:** 优化建议：
- 确保视频文件已经下载到本地（使用 `downloadFileToLocal`）
- 检查本地视频目录的访问权限
- 考虑减小视频片段的数量

### Q4: 合并过程中断

**A:** 处理方法：
- 检查服务器日志获取错误详情
- 确认 FFmpeg npm 包已正确安装
- 尝试重启后端服务

## 📊 性能优化

### 1. 视频预处理

- 使用 `-c copy` 参数避免重新编码
- 确保所有视频使用相同的编码格式
- 使用较高的压缩率减小文件大小

### 2. 并发控制

- 每次只生成一个视频片段
- 等待当前视频完成后再生成下一个
- 避免同时生成多个视频导致资源竞争

### 3. 缓存策略

- 已生成的视频会缓存到本地
- 使用 `videoUrl` 字段存储本地路径
- 避免重复下载相同的视频

## 🎨 界面说明

### 左侧：原始素材区
- 上传图片的区域
- 显示已上传图片的缩略图
- 支持继续添加或清空全部

### 右侧：拼接预览区
- 显示每个视频片段的详细信息：
  - 原始图片
  - 导演指令
  - 生成结果
- 每个片段包含三个部分：
  - 左：原始图片和状态标签
  - 中：导演指令和操作按钮
  - 右：生成结果和操作按钮

### 底部：作品合成区
- 显示完成的视频数量
- "导出完整视频"按钮（仅在所有视频就绪时可用）

## 🔍 调试信息

### 启用详细日志

在 `server.js` 中已经有详细的日志输出：

```javascript
console.log(`🎬 [视频合并] 收到合并请求，视频数量: ${videoUrls.length}`);
console.log('📥 下载视频 1/5: ...');
console.log('✅ 所有视频下载完成，开始合并...');
console.log('🚀 FFmpeg 命令: ...');
console.log('⏳ 合并进度: 50.0%');
console.log('✅ 视频合并成功!');
```

### 常见错误代码

- `400`: 视频列表为空或格式错误
- `500`: FFmpeg 执行失败或网络错误
- `404`: 视频文件不存在

## 📞 技术支持

如果遇到问题，请提供以下信息：

1. 错误信息（浏览器控制台和服务器日志）
2. 视频片段数量和时长
3. 视频文件格式和大小
4. 网络连接状况

---

**最后更新：2026年1月7日**
**版本：1.0.0**
