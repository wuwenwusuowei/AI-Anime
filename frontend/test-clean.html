<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¨ EduMatch æ¼«æ”¹è§†é¢‘ç”Ÿæˆå™¨ - æµ‹è¯•ç‰ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; }
        .upload-box { border: 2px dashed #ccc; height: 200px; display: flex; align-items: center; justify-content: center; margin: 20px 0; cursor: pointer; }
        .upload-box:hover { border-color: #007bff; }
        .preview-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 10px 0; }
        .controls { display: flex; gap: 10px; margin: 10px 0; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #ccc; }
        select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .status-box { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; text-align: center; }
        .COMPLETED { color: green; }
        .PROCESSING { color: orange; }
        .error { color: red; background: #f8d7da; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div id="app">
        <h1>ğŸ¨ æ¼«æ”¹è§†é¢‘ç”Ÿæˆå™¨</h1>
        
        <div class="upload-box" @click="selectFile">
            <div v-if="!previewUrl">ğŸ“· ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
            <img v-else :src="previewUrl" class="preview-img" />
            <input type="file" @change="handleFile" ref="fileInput" style="display: none" accept="image/*">
        </div>
        
        <textarea v-model="prompt" placeholder="æè¿°åŠ¨ç”»æ•ˆæœ..." rows="3"></textarea>
        
        <div class="controls">
            <select v-model="style">
                <option value="anime">æ—¥å¼åŠ¨æ¼«</option>
                <option value="cyberpunk">èµ›åšæœ‹å…‹</option>
                <option value="ink">æ°´å¢¨å›½é£</option>
            </select>
            <button @click="generate" :disabled="loading || !file">
                {{ loading ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆè§†é¢‘' }}
            </button>
        </div>
        
        <div v-if="taskId" class="status-box">
            ä»»åŠ¡ID: {{ taskId }}<br>
            çŠ¶æ€: <span :class="status">{{ statusText }}</span>
        </div>
        
        <div v-if="videoUrl">
            <h3>âœ… ç”Ÿæˆå®Œæˆ</h3>
            <video :src="videoUrl" controls style="width: 100%; margin-top: 10px;"></video>
        </div>
        
        <div v-if="error" class="error" @click="error = ''">
            âŒ {{ error }} (ç‚¹å‡»æ¸…é™¤)
        </div>
    </div>

    <script>
        const { createApp, ref } = Vue;
        
        createApp({
            setup() {
                const prompt = ref('');
                const style = ref('anime');
                const loading = ref(false);
                const taskId = ref(null);
                const status = ref('');
                const videoUrl = ref('');
                const error = ref('');
                const file = ref(null);
                const previewUrl = ref('');
                const fileInput = ref(null);
                
                const statusText = ref('');
                
                const selectFile = () => fileInput.value.click();
                
                const handleFile = (e) => {
                    const selectedFile = e.target.files[0];
                    if (selectedFile) {
                        file.value = selectedFile;
                        previewUrl.value = URL.createObjectURL(selectedFile);
                        error.value = '';
                    }
                };
                
                const generate = async () => {
                    if (!file.value) {
                        error.value = 'è¯·å…ˆé€‰æ‹©å›¾ç‰‡';
                        return;
                    }
                    
                    loading.value = true;
                    error.value = '';
                    
                    try {
                        const formData = new FormData();
                        formData.append('image', file.value);
                        formData.append('prompt', prompt.value);
                        formData.append('style', style.value);
                        
                        const res = await fetch('http://localhost:3000/api/generate', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await res.json();
                        
                        if (data.success) {
                            taskId.value = data.taskId;
                            status.value = 'PENDING';
                            pollStatus(data.taskId);
                        } else {
                            error.value = data.error || 'ç”Ÿæˆå¤±è´¥';
                            loading.value = false;
                        }
                    } catch (e) {
                        error.value = 'ç½‘ç»œé”™è¯¯: ' + e.message;
                        loading.value = false;
                    }
                };
                
                const pollStatus = async (id) => {
                    const interval = setInterval(async () => {
                        try {
                            const res = await fetch(`http://localhost:3000/api/status/${id}`);
                            const data = await res.json();
                            
                            status.value = data.status;
                            
                            if (data.status === 'COMPLETED') {
                                videoUrl.value = data.videoUrl;
                                loading.value = false;
                                clearInterval(interval);
                            } else if (data.status === 'FAILED') {
                                error.value = data.error || 'ç”Ÿæˆå¤±è´¥';
                                loading.value = false;
                                clearInterval(interval);
                            }
                            
                            // æ›´æ–°çŠ¶æ€æ–‡æœ¬
                            const statusMap = {
                                'PENDING': 'ğŸ“ ä»»åŠ¡å·²æäº¤',
                                'PROCESSING': 'ğŸ¨ æ­£åœ¨ç”Ÿæˆ',
                                'COMPLETED': 'âœ… ç”Ÿæˆå®Œæˆ',
                                'FAILED': 'âŒ ç”Ÿæˆå¤±è´¥'
                            };
                            statusText.value = statusMap[data.status] || data.status;
                            
                        } catch (e) {
                            console.error('è½®è¯¢é”™è¯¯:', e);
                        }
                    }, 3000);
                };
                
                return {
                    prompt, style, loading, taskId, status, videoUrl, 
                    error, file, previewUrl, fileInput, statusText,
                    selectFile, handleFile, generate
                };
            }
        }).mount('#app');
    </script>
</body>
</html>